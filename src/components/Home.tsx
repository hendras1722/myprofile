import { useState, useEffect, useRef } from "react";
import { Typed } from "typed.ts";
import { useNavigate } from "react-router-dom";
import {
  Button,
  useDisclosure,
  Modal,
  ModalContent,
  ModalBody,
} from "@chakra-ui/react";
import DuarrGif from "../assets/duarr.gif";

// Generated by https://quicktype.io

export interface IHTMLTerimnal {
  item: Item;
  index: number;
}

export interface Item {
  html: string;
}

function App() {
  const [codeStatus, setCodeStatus] = useState<boolean>();
  const el = useRef<HTMLDivElement>(null);
  const navigate = useNavigate();
  const { isOpen, onOpen, onClose } = useDisclosure();
  const [dataTerminal, setDataTerminal] = useState([
    {
      html: "input",
    },
  ]);

  const handleNext = () => {
    onOpen();
    sessionStorage.setItem("poor", "true");
    setTimeout(() => {
      onClose();
      navigate("/me");
    }, 1500);
  };

  useEffect(() => {
    sessionStorage.removeItem("poor");
  }, []);

  const handleRetry = () => {
    window.location.reload();
  };

  const typeText = () => {
    const typed = new Typed({
      callback: (text) => {
        if (el.current) {
          el.current.innerHTML = text;
        }
      },
    });
    const type = async () => {
      const line1 = "npm install MSA\n";
      const line2 = "Installing components...\n";
      const line3 = "Fetching from source...\n";
      const line4 = "Success 200 ðŸ¤ª\n";
      const line5 = `Failed 403 ðŸ˜­\n`;

      const a = [true, false];
      const randomValue = a[Math.floor(a.length * Math.random())];
      console.log(randomValue);
      typed.type(line1, { errorMultiplier: 0 });
      typed.wait(3000);
      typed.type(line2, { errorMultiplier: 0 });
      typed.wait(3000);
      typed.type(line3, { errorMultiplier: 0 });
      typed.wait(3000);
      if (randomValue) {
        typed.type(line4, { errorMultiplier: 0, className: "successTyped" });
        typed.wait(3000);
        typed.type("====================\n", { errorMultiplier: 0 });
        typed.wait(1000);
        typed.type("MSA Begin\n", {
          errorMultiplier: 0,
          className: "fontWeight",
        });
        typed.wait(1000);
        typed.type("====================\n", { errorMultiplier: 0 });
        typed.wait(1000);
      } else {
        typed.type(line5, {
          errorMultiplier: 0,
          noSpecialCharErrors: true,
          className: "errorTyped",
        });
        typed.wait(3000);
        typed.type("====================\n", { errorMultiplier: 0 });
        typed.wait(1000);
        typed.type("Oh no, please try again...\n", {
          errorMultiplier: 0,
          className: "fontWeight",
        });
        typed.wait(1000);
        typed.type("====================\n", { errorMultiplier: 0 });
        typed.wait(1000);
      }
      await typed.run();
      setDataTerminal((prev) => [
        ...prev,
        {
          html: "input",
        },
      ]);
      setCodeStatus(randomValue);

      // typed.reset();
    };
    type();
  };

  const handleSubmit = (e: React.KeyboardEvent, props: IHTMLTerimnal) => {
    let value = null;
    console.log(e, "inie");
    const typing_text = document.getElementById(`typing_text${props.index}`);
    value = typing_text?.innerText;
    const charCode = e.keyCode || e.which;
    if (!typing_text) return;
    if (charCode === 13 || e.key === "Enter") {
      typing_text.blur();
      typing_text.setAttribute("contentEditable", "false");

      if (value?.includes("npm")) {
        if (value.includes("npm i msa") || value.includes("npm install msa")) {
          setDataTerminal([
            ...dataTerminal,
            {
              html: "text",
            },
          ]);
          typeText();
        }
        return;
      } else {
        setDataTerminal([
          ...dataTerminal,
          {
            html: "input",
          },
        ]);
      }

      // return;
    }
  };
  function handleMouseEvent() {
    const typing_text = document.getElementById("typing_text");
    if (typing_text) {
      typing_text.focus();
    }
  }
  const HtmlTerminal = (props: IHTMLTerimnal) => {
    if (!props) return "wewe";
    if (props.item.html === "input") {
      return (
        <>
          <div className="flex">
            <span className="text-white">$ </span>
            <div className="text-white  w-screen ">
              <div>
                <div
                  id={"typing_text" + props.index}
                  contentEditable
                  className="text-white focus:outline-none ml-2 "
                  onKeyDown={(event) => handleSubmit(event, props)}
                  onMouseDown={handleMouseEvent}
                ></div>
              </div>
            </div>
          </div>
        </>
      );
    }
    if (props.item.html === "text") {
      return (
        <div
          style={{
            whiteSpace: "pre-line",
          }}
          className="text-white"
        >
          <span ref={el} />
        </div>
      );
    }
    return "hello";
  };

  return (
    <>
      <div>
        <div className="bg-blue-700 h-12 flex justify-end p-2 items-center">
          <div className="w-20 flex justify-between">
            <div className="bg-red-100 h-4 w-4 rounded-xl"></div>
            <div className="bg-red-100 h-4 w-4 rounded-xl"></div>
            <div className="bg-red-100 h-4 w-4 rounded-xl"></div>
          </div>
        </div>
        <div
          className="bg-black h-96 p-2 items-center h-9/6"
          id="container_typing"
        >
          {dataTerminal.map(
            (item, index) => (
              <div key={index}>{HtmlTerminal({ item, index })}</div>
            )
            // <div key={index}>
            //   <HtmlTerminal item={item} index={index} />
            // </div>
          )}
          {/* <div
            id="typing_text"
            contentEditable
            className="text-white focus:outline-none"
            onKeyDown={handleSubmit}
          ></div> */}
          {/* <div
            style={{
              whiteSpace: "pre-line",
            }}
            className="text-white"
          >
            $ <span ref={el} /> <span>|</span>
          </div> */}
        </div>

        {/* <div style={{ position: "relative" }}>
          <div
            style={{
              position: "absolute",
              color: "white",
              fontWeight: "bold",
              right: 10,
              top: 8,

              borderRadius: "50%",
              width: 10,
              height: 10,
              background: "red",
            }}
          ></div>
        </div> */}
        {/* <div
          style={{
            background: "black",
            padding: 10,
            height: 300,
            borderTop: "25px solid blue",
            borderRadius: 8,
            color: "white",
            textAlign: "left",
            fontSize: 22,
            whiteSpace: "pre-line",
            overflow: "auto",
          }}
        >
          $ <span ref={el} /> <span>|</span>
        </div> */}
        <Modal onClose={onClose} size={"full"} isOpen={isOpen}>
          <ModalContent className="modalContent">
            <ModalBody className="modalBodyCustom">
              <img src={DuarrGif} style={{ width: "50%" }} />
            </ModalBody>
          </ModalContent>
        </Modal>

        {codeStatus && (
          <>
            <div
              style={{
                display: "flex",
                justifyContent: "center",
                marginTop: 20,
              }}
            >
              <Button onClick={handleNext} colorScheme="blue">
                Lanjutkan
              </Button>
            </div>
          </>
        )}
        {codeStatus === false && (
          <>
            <div style={{ textAlign: "center", marginTop: "20px" }}>
              <p>
                <q
                  style={{
                    fontWeight: "bold",
                    color: "#7d7d7d",
                    fontStyle: "italic",
                  }}
                >
                  Masih gagal tetap lah mencoba kesempatan tidak akan datang
                  untuk orang yang tidak ingin mencoba
                </q>
              </p>
            </div>
            <div
              style={{
                display: "flex",
                justifyContent: "center",
                marginTop: 20,
              }}
            >
              <Button onClick={handleRetry} colorScheme="red">
                Retry
              </Button>
            </div>
            <div className="text-center">
              Sudah menyerah ?{" "}
              <a
                href="javascript:void(0)"
                onClick={handleNext}
                className="text-blue-700"
                font-bold
              >
                {" "}
                klik disini
              </a>
            </div>
          </>
        )}
      </div>
    </>
  );
}

export default App;
